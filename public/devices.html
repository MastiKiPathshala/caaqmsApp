<!DOCTYPE html>
<head>
<title>Devices</title>

<meta name="author" content="Taniya Datta">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <link rel='stylesheet' href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css"/> 
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel='stylesheet prefetch' href='css/cjbzr.css'/>
  <link rel='stylesheet prefetch' type="text/css" href="css/style.css"/>
  <link rel="stylesheet" type="text/css" href="http://weloveiconfonts.com/api/?family=entypo"/>
 
  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap.min.js"></script>
  <script type="text/javascript" src="js/location.js"></script>

  <style type="text/css">
    .sidenav {
    height: 95%;
    width: 0;
    position: fixed;
    z-index: 100;
    margin-top: 40px;
    right: 0;
    float: right;
    background-color: rgb(240,240,240);
    overflow-x: hidden;
    transition: 0.5s;
    padding-top: 1%;
    font-size: 20px;
    color: black;
    border-style: solid;
    border-width: 2px;

}
.box {
    background-color:white;
    width: 90%;
    height: auto;
    border-style: solid;
    border-width: 1px;
    font-size: 8px;
    padding: 8px 8px 8px;
    margin: 8px 8px 8px 25px ;
}
.sidenav a {
    padding: 8px 8px 8px 10px;
    text-decoration: none;
    font-size: 25px;
    color: #818181;
    display: block;
    transition: 0.3s;
}

.sidenav a:hover, .offcanvas a:focus{
    color:black;
}

.sidenav .closebtn {
    position: absolute;
    top: 0;
    right: 25px;
    font-size: 36px;
    margin-right: 0px;
}

div p
{
  font-size:150%;
  text-align: left;
}
#details a
{
  font-size:80%;
  margin-left: 10%;
 

}
#properties
{
	font-size: 12px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
  </style>
  <script type="text/javascript">
      $(function(){
        var includes = $('[data-include]');
          jQuery.each(includes, function(){
             var file =$(this).data('include') + '.html';
                $(this).load(file);
    });
  });

  </script>
</head>

<body >
<div data-include="header"></div>

<div class="row">
  <div class="col-sm-1">
   <!-- Sidebar -->
    <div data-include="sidebar"></div>
  </div>

           
      
      
<div class="col-sm-11">
  <div id="mySidenav" class="sidenav"></div>
<!--Table-->
<div class="container" style="margin-top:5%;margin-left:0%;position:absolute; width:95%">
  <h2 class="entypto-arrows-ccw" style="display:inline">All Devices<a onclick="refresh()">
  <span class="entypo-arrows-ccw" style="font-size: 30px;margin-left:2%"></span></a>&emsp;&emsp;  </h2><button onclick="jobSchedule()" style="margin-left:40%">JOB SCHEDULER</button>&ensp; <button onclick="addDevice()">ADD DEVICE</button>&nbsp;<input type="text" name="deviceId" value="YourDeviceName" id ="newDevice">
    <table id="table" class="table table-bordered table-hover table-responsive" width="100%" style="background-color:white;overflow-x:scroll">
    <col width="">
    <col width="">
    <col width="15%">
    <col width="13%">
    <col width="18%">
    <col width="25%">
    <col width="25%">
      <thead class="thead-inverse">
        <tr>
          <th></th>
          <th height="10px">STATUS</th>
          <th>DEVICE ID</th>
          <th>MANUFACTURER</th>
          <th>HARDWARE VERSION</th>
          <th>SOFTWARE VERSION</th>
          <th>LAST REBOOT TIME</th>
        </tr>
      </thead>
  
      <tbody>
    
      </tbody>
   </table>

</div>
</div>
</div>

<script type="text/javascript">
function addDevice()
{   var deviceName =$('#newDevice').val();
   alert(deviceName);
	$.ajax({
  method: 'POST',
  url: '/api/deviceManagement/v1.0/createDevice/'+deviceName,
 }).done(function(data) {

  if (data.status === "OK") {
   console.log(data.results);
   refresh();
   
  } else {
   console.log(data.results);
   
  }
  
 }).fail(function(data) {
      console.log (data);
    });
}
function jobSchedule()
{
  openNav();
  $('.row .col-sm-11 #mySidenav').html('<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>');
  var html1 ="<p>&ensp;&nbsp;Jobs</p><div class='box'><a><span id='twin' style='font-size:25px'>Edit Device Twin</span></a><br/><a><span id='job' style='font-size:25px'>Invoke Method</span></a></div>";
  $('.row .col-sm-11 #mySidenav').append(html1);
  
  var deviceId,devicesForScheduling=[];
  window.localStorage.removeItem('devicesForScheduling');
  
  if($('.container #table :checkbox:checked').length > 0)
  { 
      $('.container #table :checkbox:checked').each(function () {
        deviceId=$('.container #table :checkbox:checked').attr("name");
        devicesForScheduling.push(deviceId);
    });

    window.localStorage.setItem('devicesForScheduling',JSON.stringify(devicesForScheduling));
    alert(devicesForScheduling);
}
else
{ 
  $('.container #table :checkbox:unchecked').each(function () {
        deviceId=$('.container #table :checkbox').attr("name");
        devicesForScheduling.push(deviceId);

    });
  window.localStorage.setItem('devicesForScheduling',JSON.stringify(devicesForScheduling));
  alert(devicesForScheduling);
}

 
}

$(document).on("click", "#job", function(){
  window.open('scheduleMethod.html', '_parent');

});
$(document).on("click", "#twin", function(){
  window.open('scheduleTwin.html', '_parent');

});

 /*$("a").click(function(e) {
        e.preventDefault();
    $("a").toggleClass('show');
  });*/
  $(document).on("click", "#editDesired", function(){
  window.open('editDesired.html', '_parent');

});
  $(document).on("click", "#editTags", function(){
  window.open('editTags.html', '_parent');

});
  $(document).on("click", "#methods", function(){
  window.open('methods.html', '_parent');

});
  $(document).on("click", "#addRule", function(){
  window.open("addRule.html", "_parent");

});
  $(document).on("click", "#removeDevice", function(){

   var deviceId = window.localStorage.getItem('deviceIdForMethod');
   $.ajax({
  method: 'DELETE',
  url: '/api/deviceManagement/v1.0/deleteDevice/'+deviceId,
 }).done(function(data) {

  if (data.status === "OK") {
   console.log(data.results);
   
  } else {
   console.log(data.results);
   
  }
  
 }).fail(function(data) {
      console.log (data);
    });

});
var GetWholeTwinConfig = function () 
{ 
  openNav();

  $('.row .col-sm-11 #mySidenav').html('<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a><a href="#"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Device Details </a><div id="details"><a> Disable Device</a><span id="addRule" style="font-size:25px"><a>Add Rule</a></span><a href="">Add/Delete Sensors</a><span id="methods" style="font-size:25px"><a >Execute Remote Command<br/></span></a><span id="removeDevice" style="font-size:25px"><a href="">Remove Device</a></span></div><a>Device Twin</a><div id="twin" ><a id="downloadAnchorElem" style="font-size:15px;margin-left:80%">Download</a><a href="#" style="font-size:15px;padding-left:15px"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="font-size:15px"></span>Tags </a><span id="editTags" style="font-size:25px"><a style="font-size:15px;margin-left:90%;display:inline" >Edit</a></span><div id="tags" class="box"></div><a href="#"  style="font-size:15px;padding-left:15px"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="font-size:15px"></span>Desired Properties </a><span id="editDesired" style="font-size:25px"><a style="font-size:15px;margin-left:90%;display:inline" >Edit</a></span><div id="desired" class="box"></div><a href="#"  style="font-size:15px;padding-left:15px"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="font-size:15px"></span>Reported Properties</a><div id="reported" class="box"></div></div><a href="#" ><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Device Properties</a><div id="properties" class="box"></div>');

 var deviceId = window.localStorage.getItem('deviceIdForMethod');
    $.ajax({
  method: 'GET',
  url: '/api/deviceManagement/v1.0/wholeDeviceTwinConfig/'+deviceId,
 }).done(function(data) {

  if (data.status === "OK") {
    var dataStore = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data.results));
    var dlAnchorElem = document.getElementById('downloadAnchorElem');
    dlAnchorElem.setAttribute("href", dataStore);
    dlAnchorElem.setAttribute("download", "twinConfig.json");
    //dlAnchorElem.click();

    console.log("Twin config "+data.results);
    $('.row .col-sm-11 #mySidenav #twin #tags').empty();
    $('.row .col-sm-11 #mySidenav #twin #desired').empty();
    $('.row .col-sm-11 #mySidenav #twin #reported').empty();

    for(var i = 0; i < data.results.length; i++){
      
      for(var j=0;j<(Object.keys(data.results[i].tags)).length;j++)
      {
       
            $('.row .col-sm-11 #mySidenav #twin #tags').append("<p>"+(Object.keys(data.results[i].tags))[j]+" : "+(Object.values(data.results[i].tags))[j]+"</p>");
      } 

      for(var k=0;k<(Object.keys(data.results[i].properties.desired)).length;k++)
      {
       
            $('.row .col-sm-11 #mySidenav #twin #desired').append("<p>"+(Object.keys(data.results[i].properties.desired))[k]+" : <br/>"+JSON.stringify((Object.values(data.results[i].properties.desired))[k])+"</p>");
      }
      for(var l=0;l<(Object.keys(data.results[i].properties.reported)).length;l++)
      {
       
            $('.row .col-sm-11 #mySidenav #twin #reported').append("<p>"+(Object.keys(data.results[i].properties.reported))[l]+" : "+JSON.stringify((Object.values(data.results[i].properties.desired))[l])+"</p><br/>");
      }
  
      console.log((Object.keys(data.results[0].properties.desired)).length);
 }
   
  } else {
   alert(data.results);
   
  }
  
 }).fail(function(data) {
  console.log (data);
  
 });
 $('.row .col-sm-11 #mySidenav #properties').append('<p>DEVICE ID</p><input type="text" name="deviceId" value="" id ="p1" ><input id="copy_btn1" type="button" value="copy"><br><p>HOSTNAME</p><input type="text" name="hostname" value="" id ="p2" ><input id="copy_btn2" type="button" value="copy"><br><p>KEY</p><input type="text" name="hostname" value="" id ="p3" ><input id="copy_btn3" type="button" value="copy">');
 //$('.row .col-sm-11 #mySidenav #properties $p1').val('deviceId');
 $.ajax({
  method: 'GET',
  url: '/api/deviceManagement/v1.0/hostNameDevicePrimaryKey/'+deviceId,
 }).done(function(data) {

  if (data.status === "OK") {
   console.log(data.results);
   $('.row .col-sm-11 #mySidenav #properties #p1').val(deviceId);
	$('.row .col-sm-11 #mySidenav #properties #p2').val(data.results.hostName);
	$('.row .col-sm-11 #mySidenav #properties #p3').val(data.results.devicePrimaryKey);
   
  } else { 
   console(data.results);
   
  }
  
 }).fail(function(data) {
  console.log (data);
  
 });


}

//var copyBtn = $('.row .col-sm-11 #mySidenav #properties #copy_btn1');
 $(document).on("click", "#copy_btn1", function(){
  $('.row .col-sm-11 #mySidenav #properties #p1').val().select();
  //id.select();
  document.execCommand('copy','false',null); // or 'cut'
});


/*copyBtn.addEventListener('click', function () {
  var id = document.querySelector('#p1');
  id.select();
  document.execCommand('copy'); // or 'cut'
}, false);
*/

function openNav() {
    document.getElementById("mySidenav").style.width = "30%";
    document.getElementById("table").style.marginRight = "30%";
    $('.row .col-sm-11 .container #table').css({'margin-right':'50%'})
}

function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
}


function refresh()
{
  var tb = document.getElementById('table');
    while(tb.rows.length > 1) {
      tb.deleteRow(1);
    }
  //alert("cleared");
  fillTable();
}


function fillTable(){
 
      $.ajax({
      method: 'GET',
      url: '/api/deviceManagement/v1.0/deviceId'
    
      }).done(function(data) {

    if (data.status === "OK") { 
      
      for(var i = 0; i < data.results.length; i++){
            //var x=JSON.parse(data.results[i]);
            if(data.results[i].reboot==undefined)
            {
            var row='<tr>',col;
                col = '<td ><label><input type="checkbox" name='+data.results[i].gatewayId+' ></label></td>'+'<td >'+data.results[i].status+'</td>'+'<td >'+data.results[i].gatewayId+'</td>'+'<td >'+data.results[i].manufacturer+'</td>'+'<td >'+data.results[i].hardwareVersion+'</td>'+'<td >'+data.results[i].softwareVersion+'</td>'+'<td >'+data.results[i].reboot+'</td>';
              row += col+'</tr>';
          $('.row .col-sm-11 .container #table').append(row);
          console.log(data.results[i]);
          
    }
    else{
    	var row='<tr>',col;
                col = '<td ><label><input type="checkbox" name='+data.results[i].gatewayId+' ></label></td>'+'<td >'+data.results[i].status+'</td>'+'<td >'+data.results[i].gatewayId+'</td>'+'<td >'+data.results[i].manufacturer+'</td>'+'<td >'+data.results[i].hardwareVersion+'</td>'+'<td >'+data.results[i].softwareVersion+'</td>'+'<td >'+data.results[i].reboot.lastReboot+'</td>';
              row += col+'</tr>';
          $('.row .col-sm-11 .container #table').append(row);
          console.log(data.results[i]);

      }
  }addRowHandlers();
      $('.row .col-sm-11 .container #table').DataTable();
    }
    else{ 
        console.log(data.message);
      }
  }).fail(function(data) {
      console.log (data);
    });
}

function addRowHandlers() {
    var rows = document.getElementById("table").rows;
      for (i = 1; i < rows.length; i++) {
            rows[i].onclick = function(){ 
              return function(){
               var id = this.cells[2].innerHTML;
               
               window.localStorage.setItem('deviceIdForMethod',id);
               //alert(id);
               GetWholeTwinConfig();
        };
    }
        (rows[i]);
    }
}
function methods()
{
  var deviceId = window.localStorage.getItem('deviceIdForMethod');
  var taskName=window.localStorage.getItem('taskName');
  
  console.log("Id  "+deviceId);
  var x='100';
   
   
  $('.row .col-sm-11 #mySidenav #details #methods').empty();
    if(x=='100')
    {
      $('.row .col-sm-11 #mySidenav #details #methods').append("<progress value="+x+" max='100'></progress><span id='btn' >&ensp;&#10003;</span>");
  
  }
  else{
      x++;
    $('.row .col-sm-11 #mySidenav #details #methods').append("<progress value="+x+" max='100'></progress>");
  }
}


$(document).on("click", "#btn", function(){
  $('.row .col-sm-11 #mySidenav #details #methods').empty();

});

window.onload = refresh();
/**
<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a href="#"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Device Details </a>
    <div id="details">
      <a> Disable Device</a>
      <a href="#" onclick="window.open('addRule.html', '_parent')">Add Rule</a>
      <a href="">Commands</a>
      <a href="#" onclick="window.open('methods.html', '_parent')">Methods<br/><span id="methods"/></a>
      <a href="">Remove Device</a>
    </div>
   
  
  <a>Device Twin</a>
  <div id="twin" >
  <a id="downloadAnchorElem" style="font-size:15px;margin-left:85%">Download</a>
   <a href="#" style="font-size:15px;padding-left:15px"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="font-size:15px"></span>Tags </a><a style="font-size:15px;margin-left:90%;display:inline" onclick="window.open('editTags.html', '_parent');">Edit</a>
   <div id="tags" class="box">
     
   </div>
   <a href="#"  style="font-size:15px;padding-left:15px"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="font-size:15px"></span>Desired Properties </a><a style="font-size:15px;margin-left:90%;display:inline" onclick="window.open('editDesired.html', '_parent');">Edit</a>
   <div id="desired" class="box"> 
     
   </div>
   <a href="#"  style="font-size:15px;padding-left:15px"><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true" style="font-size:15px"></span>Reported Properties</a>
   <div id="reported" class="box">
     
   </div>
    </div>

  <a href="#" ><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Device Properties</a>
  <div id="properties" class="box">
  
    </div>
  <a href="#" ><span id="glyph" class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>Recent Job</a>
  <div class="box">
    
    </div>**/
</script>

</body>
</html>